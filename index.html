<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load D3.js for Charting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom scrollbar for transaction list */
        .transaction-list::-webkit-scrollbar {
            width: 8px;
        }
        .transaction-list::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        /* Style for the table header and rows to create 6 columns */
        .grid-header {
            /* 15% Date, 10% Time, 40% Description, 15% Credit, 15% Debit, 5% Delete */
            grid-template-columns: 15% 10% 40% 15% 15% 5%; 
        }
        .grid-row {
            /* 15% Date, 10% Time, 40% Description, 15% Credit, 15% Debit, 5% Delete */
            grid-template-columns: 15% 10% 40% 15% 15% 5%;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 sm:p-8 flex justify-center">
        <div class="w-full max-w-4xl">
            <!-- Header and Auth Info (for debugging/identification) -->
            <header class="mb-8 border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800">My Personal Budget Dashboard</h1>
                <p id="auth-status" class="text-sm text-gray-500 mt-1"></p>
                <div id="loading-message" class="text-blue-500 font-medium mt-2 hidden">Initializing Firebase...</div>
            </header>

            <!-- Main Content Area -->
            <main id="main-content" class="space-y-8 hidden">
                
                <!-- Balance & Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Total Balance Card -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-blue-100">
                        <p class="text-sm font-medium text-gray-500">Current Balance</p>
                        <p id="total-balance" class="text-3xl font-extrabold mt-1 text-gray-800">₹0.00</p>
                    </div>

                    <!-- Total Income Card -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-green-100">
                        <p class="text-sm font-medium text-gray-500">Total Income</p>
                        <p id="total-income" class="text-3xl font-extrabold mt-1 text-green-600">₹0.00</p>
                    </div>

                    <!-- Total Expenses Card -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-red-100">
                        <p class="text-sm font-medium text-gray-500">Total Expenses</p>
                        <p id="total-expenses" class="text-3xl font-extrabold mt-1 text-red-600">₹0.00</p>
                    </div>
                </div>

                <!-- Pie Chart for Visualization -->
                <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Income vs. Expense Distribution</h2>
                    <div id="pie-chart" class="flex justify-center items-center">
                        <!-- D3.js chart will be rendered here -->
                    </div>
                    <div id="chart-legend" class="mt-4 flex flex-wrap justify-center space-x-6 text-sm">
                        <div class="flex items-center">
                            <span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-2"></span>
                            <span>Income</span>
                        </div>
                        <div class="flex items-center">
                            <span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                            <span>Expense</span>
                        </div>
                    </div>
                </section>
                
                <!-- Transaction Input Form (Updated with Buttons) -->
                <section class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Add New Transaction</h2>
                    <div id="transaction-input-area" class="space-y-4">
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <!-- Description Input -->
                            <input type="text" id="description" placeholder="Description (e.g., Salary, Groceries)" required
                                class="col-span-1 md:col-span-4 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                            
                            <!-- Amount Input -->
                            <input type="number" id="amount" placeholder="Amount in ₹" required step="0.01"
                                class="col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">

                            <!-- Income Button -->
                            <button type="button" id="income-btn"
                                class="col-span-1 p-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-200 shadow-md flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                                </svg>
                                Record Income
                            </button>

                            <!-- Expense Button -->
                            <button type="button" id="expense-btn"
                                class="col-span-1 p-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 shadow-md flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                                </svg>
                                Record Expense
                            </button>
                        </div>
                    </div>
                    <p id="form-message" class="mt-3 text-sm text-center hidden"></p>
                </section>

                <!-- Transaction History (Updated to Grid Layout) -->
                <section>
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Transaction History</h2>
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        
                        <!-- Table Header Mimic using Grid -->
                        <div class="grid px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 grid-header">
                            <div class="text-left">Date</div>
                            <div class="text-left">Time</div>
                            <div class="text-left">Description</div>
                            <div class="text-right">Credit</div>
                            <div class="text-right">Debit</div>
                            <div></div> <!-- Placeholder for delete button -->
                        </div>

                        <!-- Scrollable Transaction List Body -->
                        <ul id="transaction-list" class="divide-y divide-gray-100 max-h-[50vh] overflow-y-auto transaction-list">
                            <!-- Transactions are rendered here by JavaScript -->
                            <li class="p-4 text-center text-gray-500" id="empty-list-message">
                                No transactions recorded yet. Start by adding one above!
                            </li>
                        </ul>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <script type="module">
        // Global Firebase variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setLogLevel, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Set Firebase logging level to debug for easy issue identification
        setLogLevel('debug');
        
        const loadingMessage = document.getElementById('loading-message');
        const mainContent = document.getElementById('main-content');
        const authStatusElement = document.getElementById('auth-status');
        const transactionListElement = document.getElementById('transaction-list');

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                authStatusElement.innerHTML = `<span class="text-red-600">ERROR: Firebase configuration is missing. Cannot proceed.</span>`;
                loadingMessage.classList.add('hidden');
                return;
            }

            loadingMessage.classList.remove('hidden');

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 1. Listen for auth state changes to set up persistence listeners
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusElement.innerHTML = `Signed in as: <span class="font-mono text-xs p-1 bg-gray-100 rounded">${userId}</span> (Private Path)`;
                        isAuthReady = true;
                        loadingMessage.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        // Start listening for transactions
                        setupTransactionListener();
                    } else {
                        // User is signed out or initial check is done
                        authStatusElement.innerHTML = 'Not signed in. Attempting sign-in...';
                        if (!isAuthReady) {
                            // If this is the initial load and no user, attempt sign-in
                            await handleSignIn();
                        }
                    }
                });

                // 2. Perform initial sign-in attempt
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization or Sign-in Error:", error);
                authStatusElement.innerHTML = `<span class="text-red-600">Initialization failed: ${error.message}</span>`;
                loadingMessage.classList.add('hidden');
            }
        }

        /**
         * Handles the sign-in process using custom token or anonymously.
         */
        async function handleSignIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Sign-in failed:", e);
                authStatusElement.innerHTML = `<span class="text-red-600">Sign-in failed. Please check console.</span>`;
            }
        }

        /**
         * Returns the collection reference for the current user's transactions.
         */
        function getTransactionsCollection() {
            if (!db || !userId) {
                console.error("Database or User ID not ready.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/transactions
            const path = `artifacts/${appId}/users/${userId}/transactions`;
            return collection(db, path);
        }

        /**
         * Adds a new transaction to Firestore.
         */
        async function addTransaction(description, rawAmount, type) {
            const formMessage = document.getElementById('form-message');
            formMessage.classList.add('hidden');
            
            // Ensure amount is positive and convert to Rupee (keep sign logic)
            let amount = parseFloat(rawAmount);
            if (isNaN(amount) || amount <= 0) {
                 showMessage("Amount must be a positive number.", 'text-red-500');
                 return;
            }
            if (description.trim() === '') {
                 showMessage("Description cannot be empty.", 'text-red-500');
                 return;
            }


            // Apply sign based on type
            if (type === 'expense') {
                amount = -Math.abs(amount); // Ensure expense is negative
            } else {
                amount = Math.abs(amount); // Ensure income is positive
            }

            const transactionsCollection = getTransactionsCollection();
            if (!transactionsCollection) return;

            try {
                await addDoc(transactionsCollection, {
                    description: description.trim(),
                    amount: amount,
                    type: type, // 'income' or 'expense'
                    timestamp: serverTimestamp(), // Use server timestamp for ordering
                });
                showMessage("Transaction recorded successfully!", 'text-green-600');
                document.getElementById('description').value = '';
                document.getElementById('amount').value = ''; 
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage(`Failed to save transaction: ${e.message}`, 'text-red-500');
            }
        }
        
        /**
         * Deletes a transaction from Firestore.
         */
        async function deleteTransaction(id) {
            // Using a custom modal style message instead of alert/confirm
            const confirmDelete = window.confirm ? window.confirm("Are you sure you want to delete this transaction?") : true; 

            if (!confirmDelete) return;
            
            const transactionsCollection = getTransactionsCollection();
            if (!transactionsCollection) return;
            
            try {
                await deleteDoc(doc(transactionsCollection, id));
                // UI will automatically update via the onSnapshot listener
            } catch (e) {
                console.error("Error deleting document: ", e);
                // Use a temporary message box instead of alert
                // Note: since alert() is prohibited, we rely on the console error logging for debugging
                console.error(`Failed to delete transaction: ${e.message}`); 
            }
        }

        /**
         * Sets up the real-time listener for transactions.
         */
        function setupTransactionListener() {
            const transactionsCollection = getTransactionsCollection();
            if (!transactionsCollection) return;

            // Query to get all transactions, ordered by timestamp descending
            const q = query(transactionsCollection, orderBy("timestamp", "desc"));

            // Real-time listener
            onSnapshot(q, (snapshot) => {
                const transactions = [];
                let totalIncome = 0;
                let totalExpenses = 0;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const transaction = {
                        id: doc.id,
                        description: data.description,
                        amount: data.amount,
                        type: data.type,
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
                    };
                    transactions.push(transaction);

                    if (transaction.type === 'income') {
                        totalIncome += Math.abs(transaction.amount);
                    } else if (transaction.type === 'expense') {
                        totalExpenses += Math.abs(transaction.amount);
                    }
                });

                const totalBalance = totalIncome - totalExpenses;
                
                updateSummary(totalBalance, totalIncome, totalExpenses);
                renderTransactions(transactions);
                renderPieChart(totalIncome, totalExpenses); // Render the chart
            }, (error) => {
                console.error("Error listening to transactions: ", error);
                authStatusElement.innerHTML = `<span class="text-red-600">Data Error: ${error.message}</span>`;
            });
        }

        /**
         * Currency formatter for Rupee (INR).
         */
        const formatCurrency = (amount) => {
            // Use 'en-IN' locale for Indian Rupee symbol and formatting
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);
        };

        /**
         * Updates the balance summary display.
         */
        function updateSummary(balance, income, expenses) {
            const balanceElement = document.getElementById('total-balance');
            balanceElement.textContent = formatCurrency(balance);
            balanceElement.classList.remove('text-red-600', 'text-green-600', 'text-gray-800');
            balanceElement.classList.add(balance >= 0 ? 'text-green-600' : 'text-red-600');
            if (balance === 0) {
                 balanceElement.classList.remove('text-green-600', 'text-red-600');
                 balanceElement.classList.add('text-gray-800');
            }


            document.getElementById('total-income').textContent = formatCurrency(income);
            document.getElementById('total-expenses').textContent = formatCurrency(expenses);
        }

        /**
         * Renders the list of transactions, using Credit/Debit columns.
         */
        function renderTransactions(transactions) {
            transactionListElement.innerHTML = ''; // Clear existing list

            if (transactions.length === 0) {
                // If the empty message is visible, show it.
                const emptyRow = document.createElement('li');
                emptyRow.className = "p-4 text-center text-gray-500";
                emptyRow.id = "empty-list-message";
                emptyRow.textContent = "No transactions recorded yet. Start by adding one above!";
                transactionListElement.appendChild(emptyRow);
                return;
            }

            transactions.forEach(tx => {
                const isIncome = tx.type === 'income';
                const amountValue = formatCurrency(Math.abs(tx.amount));
                
                // Set Credit/Debit cells: Credit is income (green), Debit is expense (red)
                const creditCell = isIncome ? `<span class="font-medium text-green-600">${amountValue}</span>` : '';
                const debitCell = !isIncome ? `<span class="font-medium text-red-600">${amountValue}</span>` : '';

                // --- Split date and time formatting ---
                const formattedDate = new Intl.DateTimeFormat('en-IN', { 
                    month: 'short', day: 'numeric', year: 'numeric'
                }).format(tx.timestamp);
                
                const formattedTime = new Intl.DateTimeFormat('en-IN', {
                    hour: '2-digit', minute: '2-digit', hour12: true 
                }).format(tx.timestamp);
                // ------------------------------------------

                const listItem = document.createElement('li');
                // Use the custom grid-row style for consistency
                listItem.className = `p-4 grid items-center hover:bg-gray-50 transition duration-150 grid-row`; 
                listItem.innerHTML = `
                    <!-- Date -->
                    <div class="text-left text-sm text-gray-600">${formattedDate}</div>
                    
                    <!-- Time -->
                    <div class="text-left text-sm text-gray-600">${formattedTime}</div>

                    <!-- Description -->
                    <div class="text-left text-sm text-gray-800 font-medium">${tx.description}</div>
                    
                    <!-- Credit -->
                    <div class="text-right text-sm">${creditCell}</div>
                    
                    <!-- Debit -->
                    <div class="text-right text-sm">${debitCell}</div>
                    
                    <!-- Delete Button -->
                    <div class="flex justify-end">
                        <button class="text-gray-400 hover:text-red-500 transition duration-150 p-1 rounded-full" 
                                data-id="${tx.id}" aria-label="Delete transaction">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                             </svg>
                        </button>
                    </div>
                `;
                
                // Add event listener for delete button
                listItem.querySelector('button').addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    deleteTransaction(id);
                });

                transactionListElement.appendChild(listItem);
            });
        }

        /**
         * Renders the D3.js Pie/Donut chart.
         */
        function renderPieChart(totalIncome, totalExpenses) {
            // Data structure for D3
            const data = [
                { label: 'Income', value: totalIncome, color: '#10b981' }, // green-600
                { label: 'Expense', value: totalExpenses, color: '#ef4444' }  // red-500
            ];
            
            const total = totalIncome + totalExpenses;
            
            // Filter out zero entries if they represent the entire total
            const displayData = data.filter(d => d.value > 0);
            
            const container = document.getElementById('pie-chart');
            // Clear previous chart
            container.innerHTML = '';
            
            // If no data to show, display message and exit
            if (total === 0 || displayData.length === 0) {
                container.innerHTML = 
                    '<div class="text-center text-gray-500 p-8">No transaction data available to generate chart.</div>';
                return;
            }

            const size = 300;
            const radius = size / 2;

            const svg = d3.select("#pie-chart")
                .append("svg")
                .attr("viewBox", `0 0 ${size} ${size}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("display", "block")
                .style("max-width", "300px")
                .style("margin", "auto")
                .append("g")
                .attr("transform", `translate(${size / 2}, ${size / 2})`);

            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.5) // Donut chart
                .outerRadius(radius);

            const arcs = svg.selectAll(".arc")
                .data(pie(displayData))
                .enter()
                .append("g")
                .attr("class", "arc");

            // Append the slices
            arcs.append("path")
                .attr("d", arc)
                .attr("fill", (d, i) => displayData[i].color)
                .attr("stroke", "white")
                .style("stroke-width", "2px")
                .append("title") // Tooltip on hover
                .text(d => `${d.data.label}: ${formatCurrency(d.data.value)} (${(d.data.value / total * 100).toFixed(1)}%)`);

            // Add text label in the center for the Net Balance
            const netBalance = totalIncome - totalExpenses;
            const balanceColor = netBalance >= 0 ? '#10b981' : '#ef4444'; // Green or Red

            svg.append("text")
                .attr("text-anchor", "middle")
                .attr("dominant-baseline", "middle")
                .attr("fill", balanceColor) 
                .attr("font-size", "1.1rem")
                .attr("font-weight", "bold")
                .text("Net");

            svg.append("text")
                .attr("text-anchor", "middle")
                .attr("dominant-baseline", "middle")
                .attr("fill", balanceColor)
                .attr("font-size", "0.9rem")
                .attr("dy", "1.5em")
                .text(formatCurrency(netBalance));
        }
        
        /**
         * Displays a temporary message in the form area.
         */
        function showMessage(text, colorClass) {
            const formMessage = document.getElementById('form-message');
            formMessage.textContent = text;
            formMessage.className = `mt-3 text-sm text-center ${colorClass}`;
            formMessage.classList.remove('hidden');

            setTimeout(() => {
                formMessage.classList.add('hidden');
            }, 3000); // Hide after 3 seconds
        }

        // --- Event Listeners and Initialization ---

        const descriptionInput = document.getElementById('description');
        const amountInput = document.getElementById('amount');
        const incomeBtn = document.getElementById('income-btn');
        const expenseBtn = document.getElementById('expense-btn');

        // Event listener for Income button
        incomeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            addTransaction(descriptionInput.value, amountInput.value, 'income');
        });

        // Event listener for Expense button
        expenseBtn.addEventListener('click', function(e) {
            e.preventDefault();
            addTransaction(descriptionInput.value, amountInput.value, 'expense');
        });

        // Initialize the application when the script loads
        initializeFirebase();

    </script>
</body>
</html>